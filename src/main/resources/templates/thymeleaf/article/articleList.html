<html layout:decorate="~{/common/layout}">
<head>
    <title>커뮤니티</title>
</head>
<main layout:fragment="main">

    <div class="container my-12 mx-auto px-4 md:px-12">

        <div class="flex justify-between">

            <!-- category select -->
            <form id="categoryForm" th:action="@{/article?page=1}" method="get" class="w-52">
                <label for="category" class="sr-only">카테고리</label>
                <select  id="category" name="category" class="block py-2.5 px-0 w-full text-sm text-gray-500 bg-transparent border-0 border-b-2 border-gray-200 appearance-none dark:text-gray-400 dark:border-gray-700 focus:outline-none focus:ring-0 focus:border-gray-200 peer">
                    <option value="ALL">전체 글</option>
                    <option th:each="category : ${categories}" th:value="${category.value}">[[ ${category.name} ]]</option>
                </select>
            </form>


            <!-- search   -->
            <form th:action="@{/article}" method="get">
                <label for="default-search" class="mb-2 text-sm font-medium text-gray-900 sr-only dark:text-gray-300">Search</label>
                <div class="relative">
                    <div class="flex absolute inset-y-0 left-0 items-center pl-3 pointer-events-none">
                        <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <input name="category" type="hidden" th:value="${param.category}" />
                    <input name="searchMatcher" type="search" id="default-search" class="block p-4 pl-10 text-sm text-gray-900 bg-gray-50 rounded-full border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="search" required>
                </div>
            </form>

        </div>
        <!-- 검색결과 없음       -->
        <div class="text-lg text-gray-500 mt-4 pb-4 border-b-2 text-center" th:if="${articles.getTotalElements()} == 0">검색 결과와 일치하는 게시글이 존재하지 않습니다.</div>

        <div class="flex flex-wrap -mx-1 lg:-mx-4">

            <!-- Column -->
            <div th:each="article : ${articles}" class="my-1 px-1 w-1/2 md:w-1/3 lg:my-4 lg:px-4 lg:w-1/4">

                <!-- Article -->
                <article class="overflow-hidden rounded-lg shadow-lg relative">


                    <!-- badge -->
                    <div th:classappend="${article.category.tailwindBgColor}" class="absolute top-3 left-3 px-3 rounded-full" th:text="${article.category.name}"></div>


                    <!-- img -->
                    <a th:href="|/article/${article.id}|">
                        <img alt="Placeholder" class="block h-auto w-full" src="https://picsum.photos/600/400/?random">
                    </a>


                    <header class="flex items-center justify-between leading-tight p-2 md:p-4">
                        <h1 class="truncate w-48 h-5 inline-block text-medium">
                            <a class="no-underline hover:underline text-black" th:href="|/article/${article.id}|">
                                [[ ${article.title} ]]
                            </a>
                        </h1>
                        <p class="text-grey-darker text-sm">
                            [[ ${article.convertRelativeTime()} ]]
                        </p>
                    </header>

                    <footer class="flex items-center justify-between leading-none p-2 md:p-4">
                        <a class="flex items-center no-underline hover:underline text-black" th:href="|/${article.user.username}|">
                            <img alt="Placeholder" class="block rounded-full" src="https://picsum.photos/32/32/?random">
                            <p class="truncate w-36 h-5 ml-2 text-sm">
                                [[ ${article.user.nickname} ]]
                            </p>
                        </a>

                    <th:block th:unless="${@rq.login}">
                        <a like-bok class="cursor-pointer no-underline text-grey-darker" th:href="@{/article/like(id=${article.id})}">
                    </th:block>

                    <th:block th:if="${@rq.login}">
                        <a like-bok class="cursor-pointer no-underline text-grey-darker" th:hx-get="@{/ajax/article/like(id=${article.id})}">
                    </th:block>

                            <span class="">[[ ${article.likes.size()} ]]</span>
                            <i th:if="${@articleServiceImpl.hasUserLiked(article.id)}" like-icon class="fa fa-heart"></i>
                            <i th:unless="${@articleServiceImpl.hasUserLiked(article.id)}" like-icon class="fa-regular fa-heart"></i>
                        </a>

                    </footer>

                </article>
                <!-- END Article -->

            </div>
            <!-- END Column -->
        </div>
    </div>

    <!--  pagination  -->
    <nav class="text-center mb-12" aria-label="Page navigation">
        <ul class="inline-flex space-x-2">

            <li>
                <button id="firstPageBtn" class="flex items-center justify-center w-10 h-10 text-indigo-600 transition-colors duration-150 rounded-full focus:shadow-outline hover:bg-indigo-100">
                    <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20"><path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                </button>
            </li>

            <li th:each="num : ${pageRange}" class="pageBtn">

                <th:block th:unless="${#strings.equals(currentPage, num)}">
                    <button class="pagination-num">[[ ${num} ]]</button>
                </th:block>

                <th:block th:if="${#strings.equals(currentPage, num)}">
                    <button class="pagination-num-current">[[ ${num} ]]</button>
                </th:block>

            </li>

            <li>
                <button id="endPageBtn" class="flex items-center justify-center w-10 h-10 text-indigo-600 transition-colors duration-150 bg-gray-100 rounded-full focus:shadow-outline hover:bg-indigo-100">
                    <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20"><path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                </button>
            </li>

        </ul>
    </nav>

    <script th:inline="javascript">
        /*<![CDATA[*/

        // 카테고리 기본 선택 속성 추가
        const selectedCategory = ([[${param.category}]] != null ? [[${param.category}]] : "ALL");
        if(selectedCategory == null){
            $("#category > option[value=ALL]").attr("selected", true);
        } else {
            $("#category > option[value="+selectedCategory+"]").attr("selected", true);
        }


        // 페이지 이동
        $(".pagination-num").on( 'click', (event) => {
            location.href = "/article?page=" + event.target.innerHTML + "&category=" + selectedCategory;
        })


        // 처음, 끝 페이지 이동
        $("#firstPageBtn").on( 'click', (event) => {
            location.href = "/article?page=1&category=" + selectedCategory;
        })
        $("#endPageBtn").on( 'click', (event) => {
            const endPage = [[ ${articles.getTotalPages()} ]]
            location.href = "/article?page=" + endPage + "&category=" + selectedCategory;
        })


        // 카테고리 변경
        $("#category").on("change", () => {
            $("#categoryForm").submit();
        })


        // 좋아요 아이콘 hover
        $('a[like-bok]').each(function() {
            const likeBox = $(this);
            likeBox.hover( () => {
                const likeIcon = likeBox.find('i');
                likeIcon.toggleClass("fa-regular");
                likeIcon.toggleClass("fa");
            });
        });


        /*]]>*/
    </script>
</main>
</html>
