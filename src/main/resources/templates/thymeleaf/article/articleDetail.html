<html layout:decorate="~{/common/layout}">
<head>
    <title>게시글</title>
    <style>
        #content  img {
            width: 50% !important;
            text-align: center
        }
    </style>
</head>
<main layout:fragment="main">
    <div class="container lg:px-32 md:mx-auto mx-auto py-8">
        <div class="bg-white p-12 shadow-md rounded-lg relative">

            <div class="flex items-center justify-start mb-3">
                <!-- category badge  -->
                <div th:classappend="${article.category.tailwindBadge}" class="px-3 mr-3" th:text="${article.category.name}"></div>

                <!--조회수 100 미만-->
                <div th:unless="${article.hit} >= 100" class="w-auto rounded-full bg-gray-200 px-3">
                    <i class="fas fa-bolt"></i>
                    <span th:text="${article.hit}"></span>
                </div>

                <!--조회수 100 이상-->
                <div th:if="${article.hit} >= 100" class="w-auto rounded-full bg-red-200 px-3">
                    <i class="fas fa-fire"></i>
                    <span th:text="${article.hit}"></span>
                </div>
            </div>

            <!-- title -->
            <h1 class="text-2xl font-semibold mb-7">[[ ${article.title} ]]</h1>

                <div class="flex justify-between items-center mb-16">

                    <div class="inline-flex items-center">
                        <!-- user -->
                        <a class="flex items-center no-underline hover:underline text-black" th:href="|/${article.user.username}|">
                            <img alt="Placeholder" class="block rounded-full" src="https://picsum.photos/32/32/?random">
                            <p class="truncate w-auto h-5 ml-2 text-sm">
                                [[ ${article.user.nickname} ]]
                            </p>
                        </a>

                        <div class="mx-2">•</div>

                        <!-- createAt -->
                        <p class="text-grey-darker text-sm">
                            [[ ${article.convertRelativeTime()} ]]
                        </p>

                        <div class="mx-2">•</div>

                        <!-- liks -->
                        <th:block th:unless="${@rq.login}">
                            <a like-bok class="cursor-pointer no-underline text-grey-darker" th:href="@{/article/like(id=${article.id})}">
                        </th:block>
                        <th:block th:if="${@rq.login}">
                            <a like-bok class="cursor-pointer no-underline text-grey-darker" th:hx-get="@{/ajax/article/like(id=${article.id})}">
                        </th:block>
                        <span class="">[[ ${article.likes.size()} ]]</span>
                        <i th:if="${@articleServiceImpl.hasUserLiked(article.id)}" like-icon class="fa fa-heart"></i>
                        <i th:unless="${@articleServiceImpl.hasUserLiked(article.id)}" like-icon class="fa-regular fa-heart"></i>
                        </a>
                    </div>

                    <div>
                        <a th:if="${@rq.user.id == article.user.id}" class="hover:text-sbs mr-3" th:href="|/article/write?id=${article.id}|">수정</a>
                        <a th:if="${@rq.user.id == article.user.id}" class="hover:text-sbs" th:href="|/article/delete?id=${article.id}|">삭제</a>
                    </div>

                </div>

            <!-- content -->
            <div id="content" class="white-space: pre-line" th:utext="${article.content}"></div>
        </div>
    </div>










    <br><br>
    <h1>댓글 작성 폼</h1>

    <form th:action="|/comment/write?articleId=${article.id}|" method="POST">
        <!-- 댓글 내용 입력 필드 -->
        <div class="mb-3">
            <label for="content" class="form-label">댓글 내용</label>
            <textarea class="form-control" id="content" name="content" rows="4" required></textarea>
         </div>
        <!-- 댓글 작성 버튼 -->
        <button type="submit" class="btn btn-primary">댓글 작성</button>
    </form>

    <br><br>
    <div th:if="${article.comments.size()} == 0" th:text="|작성된 댓글이 없습니다.|"></div>
    <ul>
        <li th:each="comment : ${article.comments}">
            <div th:text="|${comment.likes.size()}개의 좋아요|"></div>
            <span>
                <a th:href="|/comment/like?articleId=${article.id}&commentId=${comment.id}|">추천</a>
            </span>
            <div th:text="${comment.user.nickname}"></div>
            <div th:text="${comment.createAt}"></div>
            <form class="commentModifyForm" th:action="|/comment/write?articleId=${article.id}&commentId=${comment.id}|" method="post" th:id="|commentModifyForm${comment.id}|">
                <textarea name="content" th:text="${comment.content}" rows="2" required></textarea>
                <button style="display: none" th:comment_id="${comment.id}" onclick="commentReadMode(this)">수정하기</button>
            </form>
            <span></span>
            <button th:if="${@rq.user.id} == ${comment.user.id}" th:id="|modifyModeBtn${comment.id}|" th:comment_id="${comment.id}" onclick="commentModifyMode(this)">수정</button>
            <button th:if="${@rq.user.id} == ${comment.user.id} or ${@rq.isAdmin()}" th:comment_id="${comment.id}" onclick="deleteComment(this)">삭제</button>
            <br><br>
        </li>
    </ul>

    <br><br>

<script th:inline="javascript">
    /*<![CDATA[*/

    // 좋아요 아이콘 hover
        $('a[like-bok]').each(function() {
            const likeBox = $(this);
            likeBox.hover( () => {
                const likeIcon = likeBox.find('i');
                likeIcon.toggleClass("fa-regular");
                likeIcon.toggleClass("fa");
            });
        });

    $(document).ready( () => {
        $(".commentModifyForm > textarea").prop("disabled", true);
    })




    function commentModifyMode(e){
        const commentId = e.getAttribute("comment_id");
        $("#commentModifyForm" + commentId + " > textarea").prop("disabled", false);
        $("#commentModifyForm" + commentId + " > button").css('display', 'inline');
        $("#modifyModeBtn" + commentId).css('display', 'none');
    }

    function commentReadMode(e){
        const commentId = e.getAttribute("comment_id");

        // form 데이터 submit
        $("#commentModifyForm" + commentId).submit();
    }

    function deleteComment(e){
        const commentId = e.getAttribute("comment_id");
        const articleId = [[ ${article.id} ]];
        location.href = "/comment/delete?articleId=" + articleId + "&commentId=" + commentId;
    }



    /*]]>*/
</script>
</main>
</html>